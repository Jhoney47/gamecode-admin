<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameCode åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 20px 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            font-weight: 600;
        }

        .sync-status {
            display: inline-block;
            margin-left: 15px;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .sync-status.success {
            background: #d4edda;
            color: #155724;
        }

        /* å¸ƒå±€å®¹å™¨ */
        .container {
            display: flex;
            height: calc(100vh - 81px);
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .stat-value.highlight {
            color: #007bff;
        }

        .stat-value.warning {
            color: #ffc107;
        }

        .stat-value.success {
            color: #28a745;
        }

        /* åˆ†ç±»é€‰æ‹© */
        .category-selector {
            margin: 20px 0;
        }

        .category-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: all 0.2s;
        }

        .category-btn:hover {
            background: #f8f9fa;
        }

        .category-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* æ¸¸æˆé€‰æ‹©åŒºåŸŸ */
        .game-selector {
            margin: 20px 0;
        }

        .game-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* æ“ä½œæŒ‰é’® */
        .action-buttons {
            margin-top: 20px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 250px;
        }

        /* å…‘æ¢ç è¡¨æ ¼ */
        .codes-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .code-text {
            font-weight: 600;
            color: #007bff;
            font-size: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #6c757d;
        }

        .accuracy-badge {
            font-weight: 600;
        }

        .accuracy-high {
            background: #d4edda;
            color: #155724;
        }

        .accuracy-medium {
            background: #fff3cd;
            color: #856404;
        }

        .accuracy-low {
            background: #f8d7da;
            color: #721c24;
        }

        /* æ“ä½œæŒ‰é’® */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-edit:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        .detail-row {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            width: 140px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .detail-value a {
            color: #007bff;
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ® GameCode åå°ç®¡ç†ç³»ç»Ÿ <span class="sync-status success" id="syncStatus">å·²åŒæ­¥</span></h1>
    </div>

    <div class="container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
            <div class="stat-card">
                <div class="stat-label">æ€»æ¸¸æˆæ•°</div>
                <div class="stat-value" id="totalGames">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»å…‘æ¢ç æ•°</div>
                <div class="stat-value highlight" id="totalCodes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å³å°†è¿‡æœŸ</div>
                <div class="stat-value warning" id="expiringSoon">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€æ–°å‘å¸ƒ</div>
                <div class="stat-value success" id="recentlyAdded">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡å‡†ç¡®ç‡</div>
                <div class="stat-value" id="avgAccuracy">N/A</div>
            </div>

            <h2>ğŸ·ï¸ åˆ†ç±»ç­›é€‰</h2>
            <div class="category-selector">
                <button class="category-btn active" data-category="all">ğŸ“‹ å…¨éƒ¨å…‘æ¢ç </button>
                <button class="category-btn" data-category="expiring">â° å³å°†è¿‡æœŸ (7å¤©å†…)</button>
                <button class="category-btn" data-category="recent">ğŸ†• æœ€æ–°å‘å¸ƒ (7å¤©å†…)</button>
            </div>

            <h2>ğŸ® é€‰æ‹©æ¸¸æˆ</h2>
            <div class="game-selector">
                <select id="gameSelect">
                    <option value="">-- è¯·é€‰æ‹©æ¸¸æˆ --</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showAddGameModal()">â• æ·»åŠ æ¸¸æˆ</button>
                <button id="deleteGameBtn" class="btn btn-delete" onclick="deleteCurrentGame()"
                    style="display: none; background-color: #dc3545; color: white;">ğŸ—‘ï¸ åˆ é™¤å½“å‰æ¸¸æˆ</button>
                <button class="btn btn-success" onclick="showAddCodeModal()">â• æ·»åŠ å…‘æ¢ç </button>
                <button class="btn btn-secondary" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button id="undoBtn" class="btn btn-secondary" onclick="undo()" title="æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ" disabled>â†©ï¸ æ’¤é”€</button>
                <button class="btn btn-warning" onclick="pushToGitHub()" title="å°†æœ¬åœ°æ•°æ®æ¨é€åˆ° GitHub">ğŸ”¼ æ¨é€åˆ° GitHub</button>
                <button class="btn btn-info" onclick="pullFromGitHub()" title="ä» GitHub æ‹‰å–æœ€æ–°æ•°æ®">ğŸ”½ ä» GitHub è·å–</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="content-header">
                <div class="content-title" id="contentTitle">å…¨éƒ¨å…‘æ¢ç </div>
                <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢å…‘æ¢ç ...">
            </div>

            <div class="codes-table">
                <table>
                    <thead>
                        <tr>
                            <th>å…‘æ¢ç </th>
                            <th>å¥–åŠ±</th>
                            <th>çŠ¶æ€</th>
                            <th>æˆªæ­¢æ—¥æœŸ</th>
                            <th>æ¥æº</th>
                            <th>å‡†ç¡®ç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">ğŸ“¦</div>
                                <div class="empty-state-text">æš‚æ— æ•°æ®</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">å…‘æ¢ç è¯¦æƒ…</h2>
                <button class="close-btn" onclick="closeModal('viewModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- è¯¦æƒ…å†…å®¹ -->
            </div>
            <button class="btn btn-secondary" onclick="closeModal('viewModal')">å…³é—­</button>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç¼–è¾‘å…‘æ¢ç </h2>
                <button class="close-btn" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editGameName">
                    <input type="hidden" id="editOriginalCode">

                    <div class="form-group">
                        <label class="form-label">å…‘æ¢ç </label>
                        <input type="text" class="form-input" id="editCode" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¥–åŠ±æè¿°</label>
                        <textarea class="form-input" id="editReward" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¥æºå¹³å°</label>
                        <input type="text" class="form-input" id="editSource">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¥æºURL</label>
                        <input type="url" class="form-input" id="editSourceUrl">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" class="form-input" id="editExpireDate">
                        <small style="color: #666; font-size: 12px;">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çŠ¶æ€</label>
                        <select class="form-input" id="editStatus">
                            <option value="active">æœ‰æ•ˆ</option>
                            <option value="expired">å·²è¿‡æœŸ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çˆ¬å–æ¥æº</label>
                        <select class="form-input" id="editCrawlSource">
                            <option value="manual">æ‰‹åŠ¨</option>
                            <option value="auto">è‡ªåŠ¨</option>
                            <option value="api">API</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‡†ç¡®ç‡ (%)</label>
                        <input type="number" class="form-input" id="editAccuracy" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">éªŒè¯æˆåŠŸç‡ (%)</label>
                        <input type="number" class="form-input" id="editVerificationRate" min="0" max="100">
                    </div>

                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æ¸¸æˆæ¨¡æ€æ¡† -->
    <div class="modal" id="addGameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ æ¸¸æˆ</h2>
                <button class="close-btn" onclick="closeModal('addGameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addGameForm">
                    <div class="form-group">
                        <label class="form-label">æ¸¸æˆåç§°</label>
                        <input type="text" class="form-input" id="newGameName" required>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addGameModal')">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å…‘æ¢ç æ¨¡æ€æ¡† -->
    <div class="modal" id="addCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ å…‘æ¢ç </h2>
                <button class="close-btn" onclick="closeModal('addCodeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCodeForm">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ¸¸æˆ</label>
                        <select class="form-input" id="addCodeGame" required>
                            <option value="">-- è¯·é€‰æ‹©æ¸¸æˆ --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å…‘æ¢ç </label>
                        <input type="text" class="form-input" id="addCode" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¥–åŠ±æè¿°</label>
                        <textarea class="form-input" id="addReward" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¥æºå¹³å°</label>
                        <input type="text" class="form-input" id="addSource">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¥æºURL</label>
                        <input type="url" class="form-input" id="addSourceUrl">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" class="form-input" id="addExpireDate">
                        <small style="color: #666; font-size: 12px;">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çˆ¬å–æ¥æº</label>
                        <select class="form-input" id="addCrawlSource">
                            <option value="manual">æ‰‹åŠ¨</option>
                            <option value="auto">è‡ªåŠ¨</option>
                            <option value="api">API</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‡†ç¡®ç‡ (%)</label>
                        <input type="number" class="form-input" id="addAccuracy" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">éªŒè¯æˆåŠŸç‡ (%)</label>
                        <input type="number" class="form-input" id="addVerificationRate" min="0" max="100">
                    </div>

                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCodeModal')">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let gameData = { games: [] };
        let currentCategory = 'all';
        let currentGame = '';
        let filteredCodes = [];

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('/api/games');
                gameData = await response.json();
                updateStats();
                updateGameSelect();
                filterAndDisplayCodes();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = calculateStats();
            document.getElementById('totalGames').textContent = stats.totalGames;
            document.getElementById('totalCodes').textContent = stats.totalCodes;
            document.getElementById('expiringSoon').textContent = stats.expiringSoon;
            document.getElementById('recentlyAdded').textContent = stats.recentlyAdded;
            document.getElementById('avgAccuracy').textContent = stats.avgAccuracy;
        }

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateStats() {
            let totalCodes = 0;
            let expiringSoon = 0;
            let recentlyAdded = 0;
            let totalAccuracy = 0;
            let accuracyCount = 0;

            const now = new Date();
            const sevenDaysLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            gameData.games.forEach(game => {
                totalCodes += game.codeCount;
                game.codes.forEach(code => {
                    // å³å°†è¿‡æœŸ
                    if (code.expireDate) {
                        const expireDate = new Date(code.expireDate);
                        if (expireDate > now && expireDate <= sevenDaysLater) {
                            expiringSoon++;
                        }
                    }

                    // æœ€æ–°å‘å¸ƒ
                    const publishDate = new Date(code.publishDate);
                    if (publishDate >= sevenDaysAgo) {
                        recentlyAdded++;
                    }

                    // å‡†ç¡®ç‡
                    if (code.accuracyRate !== null && code.accuracyRate !== undefined) {
                        totalAccuracy += code.accuracyRate;
                        accuracyCount++;
                    }
                });
            });

            return {
                totalGames: gameData.games.length,
                totalCodes,
                expiringSoon,
                recentlyAdded,
                avgAccuracy: accuracyCount > 0 ? (totalAccuracy / accuracyCount).toFixed(1) + '%' : 'N/A'
            };
        }

        // æ›´æ–°æ¸¸æˆé€‰æ‹©æ¡†
        function updateGameSelect() {
            const select = document.getElementById('gameSelect');
            const addCodeSelect = document.getElementById('addCodeGame');

            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¸¸æˆ --</option>';
            addCodeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¸¸æˆ --</option>';

            gameData.games.forEach(game => {
                const option1 = document.createElement('option');
                option1.value = game.gameName;
                option1.textContent = `${game.gameName} (${game.codeCount})`;
                select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = game.gameName;
                option2.textContent = game.gameName;
                addCodeSelect.appendChild(option2);
            });
        }

        // è¿‡æ»¤å¹¶æ˜¾ç¤ºå…‘æ¢ç 
        function filterAndDisplayCodes() {
            const now = new Date();
            const sevenDaysLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            filteredCodes = [];

            gameData.games.forEach(game => {
                // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæ¸¸æˆï¼Œåªæ˜¾ç¤ºè¯¥æ¸¸æˆçš„å…‘æ¢ç 
                if (currentGame && game.gameName !== currentGame) {
                    return;
                }

                game.codes.forEach(code => {
                    let shouldInclude = false;

                    if (currentCategory === 'all') {
                        shouldInclude = true;
                    } else if (currentCategory === 'expiring') {
                        // å³å°†è¿‡æœŸï¼š7å¤©å†…è¿‡æœŸ
                        if (code.expireDate) {
                            const expireDate = new Date(code.expireDate);
                            if (expireDate > now && expireDate <= sevenDaysLater) {
                                shouldInclude = true;
                            }
                        }
                    } else if (currentCategory === 'recent') {
                        // æœ€æ–°å‘å¸ƒï¼š7å¤©å†…å‘å¸ƒ
                        const publishDate = new Date(code.publishDate);
                        if (publishDate >= sevenDaysAgo) {
                            shouldInclude = true;
                        }
                    }

                    if (shouldInclude) {
                        filteredCodes.push({
                            ...code,
                            gameName: game.gameName
                        });
                    }
                });
            });

            // æœç´¢è¿‡æ»¤
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (searchTerm) {
                filteredCodes = filteredCodes.filter(code =>
                    code.code.toLowerCase().includes(searchTerm) ||
                    code.rewardDescription.toLowerCase().includes(searchTerm)
                );
            }

            displayCodes();
        }

        // æ˜¾ç¤ºå…‘æ¢ç 
        function displayCodes() {
            const tbody = document.getElementById('codesTableBody');

            if (filteredCodes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <div class="empty-state-text">æš‚æ— æ•°æ®</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCodes.map(code => {
                const statusBadge = getStatusBadge(code);
                const accuracyBadge = getAccuracyBadge(code.accuracyRate);
                const expireDateText = getExpireDateText(code.expireDate);

                return `
                    <tr>
                        <td>
                            <div class="code-text">${code.code}</div>
                            <small style="color: #666;">${code.gameName}</small>
                        </td>
                        <td>${code.rewardDescription}</td>
                        <td>${statusBadge}</td>
                        <td>${expireDateText}</td>
                        <td>${code.sourcePlatform || '-'}</td>
                        <td>${accuracyBadge}</td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn btn-view" onclick="viewCode('${code.gameName}', '${code.code}')">æŸ¥çœ‹</button>
                                <button class="action-btn btn-edit" onclick="editCode('${code.gameName}', '${code.code}')">ç¼–è¾‘</button>
                                <button class="action-btn btn-delete" onclick="deleteCode('${code.gameName}', '${code.code}')">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // è·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(code) {
            const now = new Date();

            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (code.expireDate) {
                const expireDate = new Date(code.expireDate);
                if (expireDate < now) {
                    return '<span class="badge badge-danger">å·²è¿‡æœŸ</span>';
                }

                // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆ7å¤©å†…ï¼‰
                const sevenDaysLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                if (expireDate <= sevenDaysLater) {
                    return '<span class="badge badge-warning">å³å°†è¿‡æœŸ</span>';
                }
            }

            // æ£€æŸ¥æ˜¯å¦æœ€æ–°å‘å¸ƒï¼ˆ7å¤©å†…ï¼‰
            const publishDate = new Date(code.publishDate);
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            if (publishDate >= sevenDaysAgo) {
                return '<span class="badge badge-info">ğŸ†• æœ€æ–°</span>';
            }

            return '<span class="badge badge-success">æœ‰æ•ˆ</span>';
        }

        // è·å–å‡†ç¡®ç‡å¾½ç« 
        function getAccuracyBadge(rate) {
            if (rate === null || rate === undefined) {
                return '<span class="badge badge-secondary">N/A</span>';
            }

            let className = 'accuracy-low';
            if (rate >= 90) className = 'accuracy-high';
            else if (rate >= 70) className = 'accuracy-medium';

            return `<span class="badge accuracy-badge ${className}">${rate}%</span>`;
        }

        // è·å–æˆªæ­¢æ—¥æœŸæ–‡æœ¬
        function getExpireDateText(expireDate) {
            if (!expireDate) {
                return '<span style="color: #28a745;">æ°¸ä¹…æœ‰æ•ˆ</span>';
            }

            const date = new Date(expireDate);
            const now = new Date();

            if (date < now) {
                return `<span style="color: #dc3545;">${date.toLocaleDateString('zh-CN')}</span>`;
            }

            const daysLeft = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
            if (daysLeft <= 7) {
                return `<span style="color: #ffc107;">${date.toLocaleDateString('zh-CN')} (${daysLeft}å¤©)</span>`;
            }

            return date.toLocaleDateString('zh-CN');
        }

        // æŸ¥çœ‹å…‘æ¢ç è¯¦æƒ…
        function viewCode(gameName, code) {
            const game = gameData.games.find(g => g.gameName === gameName);
            const codeData = game.codes.find(c => c.code === code);

            const modalBody = document.getElementById('viewModalBody');
            modalBody.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">å…‘æ¢ç </div>
                    <div class="detail-value"><strong style="color: #007bff; font-size: 18px;">${codeData.code}</strong></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ¸¸æˆ</div>
                    <div class="detail-value">${gameName}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å¥–åŠ±æè¿°</div>
                    <div class="detail-value">${codeData.rewardDescription}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">çŠ¶æ€</div>
                    <div class="detail-value">${getStatusBadge(codeData)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æˆªæ­¢æ—¥æœŸ</div>
                    <div class="detail-value">${getExpireDateText(codeData.expireDate)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ¥æºå¹³å°</div>
                    <div class="detail-value">${codeData.sourcePlatform || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ¥æºURL</div>
                    <div class="detail-value">${codeData.sourceUrl ? `<a href="${codeData.sourceUrl}" target="_blank">${codeData.sourceUrl}</a>` : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">çˆ¬å–æ¥æº</div>
                    <div class="detail-value">${codeData.crawlSource || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">çˆ¬å–æ—¶é—´</div>
                    <div class="detail-value">${codeData.crawlTime ? new Date(codeData.crawlTime).toLocaleString('zh-CN') : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å‡†ç¡®ç‡</div>
                    <div class="detail-value">${getAccuracyBadge(codeData.accuracyRate)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">éªŒè¯æˆåŠŸç‡</div>
                    <div class="detail-value">${codeData.verificationSuccessRate ? codeData.verificationSuccessRate + '%' : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å‘å¸ƒæ—¶é—´</div>
                    <div class="detail-value">${new Date(codeData.publishDate).toLocaleString('zh-CN')}</div>
                </div>
            `;

            openModal('viewModal');
        }

        // ç¼–è¾‘å…‘æ¢ç 
        function editCode(gameName, code) {
            const game = gameData.games.find(g => g.gameName === gameName);
            const codeData = game.codes.find(c => c.code === code);

            document.getElementById('editGameName').value = gameName;
            document.getElementById('editOriginalCode').value = code;
            document.getElementById('editCode').value = codeData.code;
            document.getElementById('editReward').value = codeData.rewardDescription;
            document.getElementById('editSource').value = codeData.sourcePlatform || '';
            document.getElementById('editSourceUrl').value = codeData.sourceUrl || '';
            document.getElementById('editExpireDate').value = codeData.expireDate ? codeData.expireDate.split('T')[0] : '';
            document.getElementById('editStatus').value = codeData.status;
            document.getElementById('editCrawlSource').value = codeData.crawlSource || 'manual';
            document.getElementById('editAccuracy').value = codeData.accuracyRate || '';
            document.getElementById('editVerificationRate').value = codeData.verificationSuccessRate || '';

            openModal('editModal');
        }

        // åˆ é™¤å…‘æ¢ç 
        async function deleteCode(gameName, code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…‘æ¢ç  "${code}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/games/${encodeURIComponent(gameName)}/codes/${encodeURIComponent(code)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadData();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // æ¨¡æ€æ¡†æ“ä½œ
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddGameModal() {
            openModal('addGameModal');
        }

        function showAddCodeModal() {
            openModal('addCodeModal');
        }

        // åˆ†ç±»åˆ‡æ¢
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;

                // æ›´æ–°æ ‡é¢˜
                let title = 'å…¨éƒ¨å…‘æ¢ç ';
                if (currentCategory === 'expiring') title = 'å³å°†è¿‡æœŸ (7å¤©å†…)';
                if (currentCategory === 'recent') title = 'æœ€æ–°å‘å¸ƒ (7å¤©å†…)';
                document.getElementById('contentTitle').textContent = title;

                filterAndDisplayCodes();
            });
        });

        // æ¸¸æˆé€‰æ‹©
        document.getElementById('gameSelect').addEventListener('change', function () {
            currentGame = this.value;
            filterAndDisplayCodes();
        });

        // æœç´¢
        document.getElementById('searchBox').addEventListener('input', function () {
            filterAndDisplayCodes();
        });

        // åˆ é™¤å½“å‰æ¸¸æˆ
        async function deleteCurrentGame() {
            if (!currentGame) return;

            if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤æ¸¸æˆ "${currentGame}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤è¯¥æ¸¸æˆä¸‹çš„æ‰€æœ‰å…‘æ¢ç ï¼Œä¸”ä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/games/${encodeURIComponent(currentGame)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('âœ… æ¸¸æˆåˆ é™¤æˆåŠŸ');
                    currentGame = ''; // é‡ç½®å½“å‰æ¸¸æˆ
                    document.getElementById('gameSelect').value = '';
                    document.getElementById('deleteGameBtn').style.display = 'none';
                    loadData(); // é‡æ–°åŠ è½½æ•°æ®
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤æ¸¸æˆå¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // --- æ¢å¤çš„åŠŸèƒ½ ---

        function undo() {
            alert('æ’¤é”€åŠŸèƒ½æš‚æœªå®ç° (Server not ready)');
        }

        async function pushToGitHub() {
            if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨æ¨é€åˆ° GitHub å—ï¼Ÿ')) return;
            try {
                const response = await fetch('/api/sync/push', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    alert('âœ… æ¨é€æˆåŠŸ: ' + result.message);
                    document.getElementById('syncStatus').textContent = 'å·²åŒæ­¥';
                    document.getElementById('syncStatus').className = 'sync-status success';
                } else {
                    alert('âŒ æ¨é€å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function pullFromGitHub() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šå°†å¼ºåˆ¶ä» GitHubä¸‹è½½æ•°æ®å¹¶è¦†ç›–æœ¬åœ°ä¿®æ”¹ï¼ç¡®å®šç»§ç»­å—ï¼Ÿ')) return;
            try {
                const response = await fetch('/api/sync/pull', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    alert('âœ… æ‹‰å–æˆåŠŸï¼Œé¡µé¢å°†åˆ·æ–°');
                    location.reload();
                } else {
                    alert('âŒ æ‹‰å–å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const gameName = document.getElementById('editGameName').value;
            const originalCode = document.getElementById('editOriginalCode').value;
            const expireDate = document.getElementById('editExpireDate').value;

            const data = {
                code: document.getElementById('editCode').value,
                rewardDescription: document.getElementById('editReward').value,
                sourcePlatform: document.getElementById('editSource').value,
                sourceUrl: document.getElementById('editSourceUrl').value,
                expireDate: expireDate || null,
                status: document.getElementById('editStatus').value,
                crawlSource: document.getElementById('editCrawlSource').value,
                accuracyRate: parseInt(document.getElementById('editAccuracy').value) || null,
                verificationSuccessRate: parseInt(document.getElementById('editVerificationRate').value) || null
            };

            try {
                const response = await fetch(`/api/games/${encodeURIComponent(gameName)}/codes/${encodeURIComponent(originalCode)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('ä¿å­˜æˆåŠŸ');
                    closeModal('editModal');
                    loadData();
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥');
            }
        });

        document.getElementById('addGameForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const gameName = document.getElementById('newGameName').value;

            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameName })
                });

                if (response.ok) {
                    alert('æ·»åŠ æˆåŠŸ');
                    closeModal('addGameModal');
                    document.getElementById('addGameForm').reset();
                    loadData();
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                console.error('æ·»åŠ å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥');
            }
        });

        document.getElementById('addCodeForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const gameName = document.getElementById('addCodeGame').value;
            const expireDate = document.getElementById('addExpireDate').value;

            const data = {
                code: document.getElementById('addCode').value,
                rewardDescription: document.getElementById('addReward').value,
                sourcePlatform: document.getElementById('addSource').value,
                sourceUrl: document.getElementById('addSourceUrl').value,
                expireDate: expireDate || null,
                crawlSource: document.getElementById('addCrawlSource').value,
                accuracyRate: parseInt(document.getElementById('addAccuracy').value) || null,
                verificationSuccessRate: parseInt(document.getElementById('addVerificationRate').value) || null
            };

            try {
                const response = await fetch(`/api/games/${encodeURIComponent(gameName)}/codes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('æ·»åŠ æˆåŠŸ');
                    closeModal('addCodeModal');
                    document.getElementById('addCodeForm').reset();
                    loadData();
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                console.error('æ·»åŠ å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥');
            }
        });

        // åˆå§‹åŒ–
        loadData();
    </script>
</body>

</html>